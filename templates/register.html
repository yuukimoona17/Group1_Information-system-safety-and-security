<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f510.svg">
<meta charset="UTF-8">
<title>Register - 2FA RSA</title>
<script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.8.6/lib/jsrsasign-all-min.js"></script>
<style>
body {font-family: Arial, sans-serif; background: #f5f8ff; display:flex; justify-content:center; align-items:center; min-height:100vh; padding: 20px;}
.card {background:white; padding:30px; border-radius:16px; width:450px; text-align:center; box-shadow:0 0 12px rgba(0,0,0,0.1);}
input {width:90%; padding:10px; margin:8px; border:1px solid #ccc; border-radius:8px;}
button {background:#007bff; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer;}
#recoverySection {display:none; background:#eef7ff; border:1px dashed #007bff; padding:15px; margin-top:15px; border-radius:10px; text-align: left;}
#recoveryCodeList { list-style-type: none; padding-left: 0; font-family: monospace; font-weight: bold; columns: 2; -webkit-columns: 2; -moz-columns: 2; }
#recoveryCodeList li { margin-bottom: 8px; }
</style>
</head>
<body>
<div class="card">
  <h2>Create Secure Account</h2>
  <input id="reg-username" placeholder="Username"><br>
  <input id="reg-password" type="password" placeholder="Password"><br>
  <button id="registerButton" onclick="handleRegister()">Register</button>
  <p id="message" style="color:red;"></p>

  <div id="recoverySection">
    <h4>Your 10 Backup Recovery Codes</h4>
    <p><small>⚠️ Save these codes safely. Any one of them can be used to recover your account.</small></p>
    <ul id="recoveryCodeList"></ul>
  </div>
  <p>Already have an account? <a href="/login">Login here</a></p>
</div>

<script>
const msg = document.getElementById("message");
const recoveryCodeListEl = document.getElementById("recoveryCodeList");
const recoveryBox = document.getElementById("recoverySection");
const regBtn = document.getElementById("registerButton");

function showMessage(t, e=true){msg.textContent=t;msg.style.color=e?'red':'green';}
function buf2b64(buf){return btoa(String.fromCharCode(...new Uint8Array(buf)));}

async function deriveAesKey(recoveryCode, salt){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(recoveryCode), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:200000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},true,['encrypt']);
}

async function encryptPrivateKey(privateKeyPEM, recoveryCode){
  const enc = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const aesKey = await deriveAesKey(recoveryCode, salt);
  const data = enc.encode(privateKeyPEM);
  const ct = await crypto.subtle.encrypt({name:'AES-GCM',iv}, aesKey, data);
  return {salt:buf2b64(salt), iv:buf2b64(iv), ciphertext:buf2b64(ct)};
}

function generateRecoveryCode() {
    const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    let code = '';
    for (let i = 0; i < 12; i++) {
        if (i > 0 && i % 4 === 0) code += '-';
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

async function handleRegister(){
  const username=document.getElementById('reg-username').value.trim();
  const password=document.getElementById('reg-password').value.trim();
  if(!username||!password){showMessage("Please fill all fields");return;}
  regBtn.disabled=true; regBtn.textContent="Generating keys..."; showMessage("");

  try {
    const kp = KEYUTIL.generateKeypair("RSA",2048);
    const pub = KEYUTIL.getPEM(kp.pubKeyObj);
    const prv = KEYUTIL.getPEM(kp.prvKeyObj,"PKCS8PRV");

    let recoveryCodes = [];
    let encryptedKeys = [];
    for (let i = 0; i < 10; i++) {
        const code = generateRecoveryCode();
        recoveryCodes.push(code);
        const encrypted = await encryptPrivateKey(prv, code);
        encryptedKeys.push(encrypted);
    }
    
    const res = await fetch('/api/register', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username,password,publicKey:pub,encryptedPrivateKey:encryptedKeys})
    });
    const result = await res.json();

    if(res.ok){
      localStorage.setItem(`privateKey_${username}`, prv);
      
      recoveryCodeListEl.innerHTML = '';
      recoveryCodes.forEach(code => {
          const li = document.createElement('li');
          li.textContent = code;
          recoveryCodeListEl.appendChild(li);
      });

      recoveryBox.style.display='block';
      showMessage("Registration successful!", false);
      regBtn.textContent="Done";
    } else {
      showMessage(result.message||"Registration failed");
      regBtn.disabled=false; regBtn.textContent="Register";
    }
  } catch(e) {
    console.error(e);
    showMessage("An error occurred during key generation.");
    regBtn.disabled=false; regBtn.textContent="Register";
  }
}
</script>
</body>
</html>