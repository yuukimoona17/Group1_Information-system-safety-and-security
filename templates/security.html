<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f510.svg">
<meta charset="UTF-8">
<title>Account Security</title>
<script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.8.6/lib/jsrsasign-all-min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
    body {font-family: 'Poppins', Arial, sans-serif; background: #f0f2f5; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0;}
    .card {background: #ffffff; border-radius: 12px; padding: 40px; width: 450px; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.07);}
    h2 {margin-top: 0; color: #333; font-weight: 600;}
    input {width: calc(100% - 24px); padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;}
    input:focus {outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1);}
    button {background: #007bff; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; width: 100%; font-size: 16px; font-weight: 500; transition: all 0.3s ease-out; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);}
    button:hover {transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);}
    button:disabled {background: #a0a0a0; cursor: not-allowed; box-shadow: none; transform: none;}
    .error { color: #dc3545; margin-top: 15px; font-weight: 500;}
    a { color: #007bff; font-size: 14px; text-decoration: none; font-weight: 500;}
    #recoverySection {display: none; background: #f8f9fa; border: 1px dashed #007bff; padding: 15px; margin-top: 20px; border-radius: 8px; text-align: left;}
    #recoveryCodeList { list-style-type: none; padding-left: 0; font-family: monospace; font-weight: bold; columns: 2; font-size: 14px;}
</style>
</head>
<body>
<div class="card">
    <h2>Account Security</h2>
    
    {% if needs_auth %}
    <p>Please enter your password to manage security settings.</p>
    <form action="/security" method="post">
        <input name="password" type="password" placeholder="Password" required>
        <button type="submit">Continue</button>
    </form>
    {% if error %} <p class="error">{{ error }}</p> {% endif %}
    
    {% else %}
    <h4>Regenerate Recovery Codes</h4>
    <p>This will invalidate all your old codes. Save the new codes somewhere safe.</p>
    <button id="regenButton" onclick="regenerateCodes()">Generate New Codes</button>
    
    <div id="recoverySection">
        <h4>Your 10 NEW Recovery Codes</h4>
        <ul id="recoveryCodeList"></ul>
    </div>
    <p id="message" style="color:green;"></p>
    {% endif %}
    
    <p style="margin-top: 20px;"><a href="/dashboard">Back to Dashboard</a></p>
</div>

<script>
    function buf2b64(buf){return btoa(String.fromCharCode(...new Uint8Array(buf)));}
    async function deriveAesKey(recoveryCode, salt){
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(recoveryCode), {name:'PBKDF2'}, false, ['deriveKey']);
      return crypto.subtle.deriveKey({name:'PBKDF2',salt,iterations:200000,hash:'SHA-256'},keyMaterial,{name:'AES-GCM',length:256},true,['encrypt']);
    }
    async function encryptPrivateKey(privateKeyPEM, recoveryCode){
      const enc = new TextEncoder();
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const aesKey = await deriveAesKey(recoveryCode, salt);
      const data = enc.encode(privateKeyPEM);
      const ct = await crypto.subtle.encrypt({name:'AES-GCM',iv}, aesKey, data);
      return {salt:buf2b64(salt), iv:buf2b64(iv), ciphertext:buf2b64(ct)};
    }
    function generateRecoveryCode() {
        const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        let code = '';
        for (let i = 0; i < 12; i++) {if (i > 0 && i % 4 === 0) code += '-'; code += chars.charAt(Math.floor(Math.random() * chars.length));}
        return code;
    }

    async function regenerateCodes() {
        const msgEl = document.getElementById('message');
        const regenBtn = document.getElementById('regenButton');
        regenBtn.disabled = true;
        msgEl.textContent = 'Generating new codes...';

        const username = prompt("For security, please re-enter your username to confirm this action:");
        if (!username) {
            regenBtn.disabled = false;
            return;
        }
        
        const privateKeyPEM = localStorage.getItem(`privateKey_${username}`);
        if (!privateKeyPEM) {
            msgEl.textContent = 'Error: Could not find private key in this browser.';
            return;
        }

        let recoveryCodes = [];
        let encryptedKeys = [];
        for (let i = 0; i < 10; i++) {
            const code = generateRecoveryCode();
            recoveryCodes.push(code);
            const encrypted = await encryptPrivateKey(privateKeyPEM, code);
            encryptedKeys.push(encrypted);
        }
        
        const res = await fetch('/api/regenerate-codes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ encryptedPrivateKey: encryptedKeys })
        });
        
        if (res.ok) {
            const listEl = document.getElementById('recoveryCodeList');
            listEl.innerHTML = '';
            recoveryCodes.forEach(code => {
                const li = document.createElement('li');
                li.textContent = code;
                listEl.appendChild(li);
            });
            document.getElementById('recoverySection').style.display = 'block';
            msgEl.textContent = 'Success! Your old codes are now invalid.';
            
            // Sửa lỗi nút bấm
            regenBtn.textContent = 'Done! Click to return'; 
            regenBtn.disabled = false; 
            regenBtn.onclick = function() { 
                window.location.href = '/security';
            };
            
        } else {
            msgEl.textContent = 'An error occurred on the server.';
            regenBtn.disabled = false;
        }
    }
</script>
</body>
</html>